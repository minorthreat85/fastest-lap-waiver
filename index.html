  <script>
    (function () {
      const params = new URLSearchParams(location.search);

      // --- Persist "noVideo" mode using localStorage ---
      let noVideo = (params.get('novideo') === '1' || params.get('novideo') === 'true');

      try {
        const storedNoVideo = localStorage.getItem('fl_noVideo');

        // If URL says novideo=0 or novideo=false → turn OFF no-video mode and clear storage
        if (params.get('novideo') === '0' || params.get('novideo') === 'false') {
          noVideo = false;
          localStorage.removeItem('fl_noVideo');
        } else {
          // If we've ever enabled no-video before, keep it on
          if (storedNoVideo === '1') {
            noVideo = true;
          }
          // If URL currently has novideo=1/true, save it for future loads
          if (noVideo && storedNoVideo !== '1') {
            localStorage.setItem('fl_noVideo', '1');
          }
        }
      } catch (e) {
        // If localStorage is unavailable, just fall back to URL param behavior
      }

      // --- Remember if the tutorial video has already been watched ---
      let videoWatched = false;
      try {
        if (localStorage.getItem('fl_videoWatched') === '1') {
          videoWatched = true;
        }
      } catch (e) {
        // ignore if storage blocked
      }

      const startSection  = document.getElementById('startSection');
      const videoSection  = document.getElementById('videoSection');
      const waiverSection = document.getElementById('waiverSection');

      const startBtn  = document.getElementById('startVideoBtn');
      const video     = document.getElementById('tutorialVideo');
      const mainTitle = document.getElementById('mainTitle');
      const waiverFrame = document.getElementById('waiverFrame');

      // Helper: reload/clear the Jotform so the next guest gets a fresh form
      function resetWaiver() {
        if (!waiverFrame) return;
        try {
          const baseSrc = waiverFrame.getAttribute('data-base-src') || waiverFrame.src;
          // Store the base src once so we don't endlessly stack params
          if (!waiverFrame.getAttribute('data-base-src')) {
            waiverFrame.setAttribute('data-base-src', baseSrc);
          }
          const url = new URL(baseSrc, location.href);
          url.searchParams.set('_t', Date.now().toString()); // cache-buster
          waiverFrame.src = url.toString();
        } catch (e) {
          // fallback: naive reload
          waiverFrame.src = waiverFrame.src;
        }
      }

      // --- State helpers ---
      function showStart() {
        // If video is disabled OR already watched at least once,
        // go straight to the waiver and keep it reusable.
        if (noVideo || videoWatched) {
          startSection.style.display = 'none';
          videoSection.style.display = 'none';
          waiverSection.style.display = 'block';
          mainTitle.textContent = 'Sign Waiver';
          window.scrollTo({ top: 0, behavior: 'instant' });
          return;
        }

        // Normal mode, before video has been watched
        startSection.style.display = 'grid';
        videoSection.style.display = 'none';
        waiverSection.style.display = 'none';
        try { video.pause(); video.currentTime = 0; } catch (e) {}

        // Clear ?submitted=1 from URL if present
        if (params.get('submitted') === '1') {
          const url = new URL(location.href);
          url.searchParams.delete('submitted');
          history.replaceState(null, '', url.toString());
        }
        mainTitle.textContent = 'Tap to Watch Tutorial, Then Sign Waiver';
        window.scrollTo({ top: 0, behavior: 'instant' });
      }

      function showVideo() {
        startSection.style.display = 'none';
        videoSection.style.display = 'block';
        waiverSection.style.display = 'none';
        mainTitle.textContent = 'Watch Tutorial';
      }

      function showWaiver() {
        waiverSection.style.display = 'block';
        mainTitle.textContent = 'Sign Waiver';
        waiverSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Init: decide what to show on load
      (function initFromQuery() {
        // If novideo is set or stored, skip straight to waiver
        if (noVideo) {
          resetWaiver();
          showStart();  // in noVideo mode this shows the waiver
          return;
        }

        // If we're coming back from a Jotform redirect (?submitted=1),
        // keep the waiver flow going and just reset the form.
        if (params.get('submitted') === '1') {
          resetWaiver();
          // If the video has been watched already, we stay on waiver.
          // If not, we still obey the normal flow (start → video).
          showStart();
          return;
        }

        // Normal first load
        resetWaiver();
        showStart();
      }());

      // Start video with user gesture (unlocks audio)
      startBtn.addEventListener('click', async () => {
        if (noVideo) return; // in no-video mode the button should be hidden anyway
        showVideo();
        try {
          await video.play();
        } catch (err) {
          console.warn('play() blocked:', err);
        }
      });

      // On video end, mark as watched and reveal waiver
      video.addEventListener('ended', () => {
        videoWatched = true;
        try {
          localStorage.setItem('fl_videoWatched', '1');
        } catch (e) {
          // ignore if storage not available
        }
        resetWaiver();
        showWaiver();
      });

      // Handle Jotform postMessage after submission
      // so the form can be filled multiple times without rewatching the video
      window.addEventListener('message', (evt) => {
        if (!evt.origin || evt.origin.indexOf('jotform') === -1) return;
        try {
          const data = typeof evt.data === 'string' ? JSON.parse(evt.data) : evt.data;
          if (data && (data.type === 'submission-completed' || data.event === 'submission-completed')) {
            // Reload form and stay on waiver
            resetWaiver();
            // After the first time, we NEVER force the video again
            videoWatched = true;
            try {
              localStorage.setItem('fl_videoWatched', '1');
            } catch (e) {}
            showStart(); // in "videoWatched" mode, this shows the waiver, not the video
          }
        } catch (e) {
          console.warn('Invalid Jotform postMessage data', e);
        }
      }, false);
    }());
  </script>
